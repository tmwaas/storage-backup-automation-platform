---
groups:
  - name: infra-automation-storage-rules
    rules:
      # 1. Storage API is down
      - alert: StorageAPIDown
        expr: up{job="storage-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Storage API is DOWN"
          description: "Prometheus has not been able to reach the storage-api job for more than 1 minute."

      # 2. Node exporter is down (host metrics lost)
      - alert: NodeExporterDown
        expr: up{job="backup-monitor"} == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Node exporter is DOWN"
          description: "Node-exporter (backup-monitor job) has been unreachable for 5 minutes."

      # 3. Too many volumes provisioned (possible leak or runaway tests)
      - alert: HighStorageVolumeCount
        expr: storage_volumes_total > 20
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High number of storage volumes"
          description: "storage_volumes_total is {{ $value }} (> 20). Check for test data or misbehaving automation."

      # 4. Backup Failures is detected
      - alert: BackupFailuresDetected
        expr: increase(backup_failures_total[1h]) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: Backup failures detected in the last hour
          description: >
            Backup failures detected in the last hour.
            Failure count: {{ $value }}.
            Please check storage-api logs and backup-scheduler cron execution.
            
      # 5. Backup not running in 24h
      - alert: BackupNotRunning24h
        expr: increase(backup_operations_total[24h]) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "No backup executed in last 24 hours"
          description: "Backup job did not run successfully in the last 24 hours."

      # 6. Backup RPO Violation (per volume)    
      - alert: BackupRPOViolation
        expr: backup_rpo_violation == 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Backup RPO violation detected"
          description: "Volume {{ $labels.volume }} has exceeded allowed RPO."

      # 7. Backup not running at scheduled time     
      - alert: BackupNotRunningAtScheduledTime
        expr: (hour() == 17) and (rate(backup_operations_total[5m]) == 0)
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Backup not running at scheduled time"
          description: "Expected backup activity at 17:00 but no operations detected."
                                                                                                                      

     

