---
- name: Check metrics endpoint
  ansible.builtin.uri:
    url: "http://localhost:5000/metrics"
    method: GET
    return_content: yes
  register: metrics_result

- name: Assert storage metrics are correct (new metric present, legacy absent)
  ansible.builtin.assert:
    that:
      - metrics_result.status == 200
      - "'storage_volume_count' in metrics_result.content"
      - "'storage_volumes_total' not in metrics_result.content"
    fail_msg: >
      Metrics validation failed.
      Either storage_volume_count is missing
      or legacy storage_volumes_total is still present.
    success_msg: >
      OK: storage_volume_count present and legacy storage_volumes_total absent.

- name: Show metrics (debug)
  ansible.builtin.debug:
    var: metrics_result.content
