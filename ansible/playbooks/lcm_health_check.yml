---
- name: LCM Health Check – Verify Storage API & Metrics
  hosts: localhost
  gather_facts: no

  vars:
    metrics_url: "http://{{ ansible_host }}:5000/metrics"

  tasks:

    - name: Check if metrics endpoint is reachable
      ansible.builtin.uri:
        url: "{{ metrics_url }}"
        method: GET
        headers:
          X-API-TOKEN: "{{ read_token }}"
        return_content: yes
      register: metrics_result

    - name: Assert LCM health – correct storage metrics exposed
      ansible.builtin.assert:
        that:
          - metrics_result.status == 200
          - "'storage_volume_count' in metrics_result.content"
          - "'storage_volumes_total' not in metrics_result.content"
        fail_msg: >
          LCM Health Check FAILED.
          storage_volume_count missing or legacy storage_volumes_total still exposed.
        success_msg: >
          LCM Health Check OK.
          Correct storage metric exposed and legacy metric removed.

    - name: Show metrics (debug)
      ansible.builtin.debug:
        var: metrics_result.content
