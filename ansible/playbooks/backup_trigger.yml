---
- name: Trigger backups via API and record results
  hosts: localhost
  gather_facts: no

  vars:
    api_base: "http://localhost:5000/api/v1"
    read_token: "read-secret"
    backup_token: "backup-secret"

  tasks:
    # -------------------------------------------------
    # 1. List volumes (READ role required)
    # -------------------------------------------------
    - name: List volumes (GET /api/v1/volumes)
      uri:
        url: "{{ api_base }}/volumes"
        method: GET
        headers:
          X-API-TOKEN: "{{ read_token }}"
          Accept: application/json
        status_code: 200
        return_content: yes
      register: volumes

    - name: Show volume count
      debug:
        msg: "Found {{ volumes.json.count }} volumes"

    # -------------------------------------------------
    # 2. Trigger backup for each volume (BACKUP role)
    # -------------------------------------------------
    - name: Trigger backup for each volume
      uri:
        url: "{{ api_base }}/backup"
        method: POST
        headers:
          X-API-TOKEN: "{{ backup_token }}"
          Content-Type: application/json
        body_format: json
        body:
          volume: "{{ item.name }}"
        status_code:
          - 200
          - 202
        return_content: yes
      loop: "{{ volumes.json.volumes | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
      register: backup_results

    # -------------------------------------------------
    # 3. Persist backup results locally
    # -------------------------------------------------
    - name: Ensure logs directory exists
      file:
        path: logs
        state: directory

    - name: Save backup results (combined log)
      copy:
        content: "{{ backup_results.results | to_nice_json }}"
        dest: "logs/backup_results_{{ lookup('pipe','date +%Y%m%d%H%M%S') }}.json"
