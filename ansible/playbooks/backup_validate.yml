---
- name: Backup Health Validation (RPO)
  hosts: localhost
  gather_facts: false

  vars:
    api_base: "http://localhost:5000/api/v1"
    rpo_hours: 24
    timestamp: "{{ lookup('pipe','date -u +%Y%m%d%H%M%S') }}"

  tasks:
    - name: Get volumes
      uri:
        url: "{{ api_base }}/volumes"
        method: GET
        return_content: true
      register: vols

    - name: Get backups
      uri:
        url: "{{ api_base }}/backups"
        method: GET
        return_content: true
      register: bkp

    - name: Prepare data
      set_fact:
        volumes: "{{ vols.json.volumes | default([]) }}"
        backups: "{{ bkp.json.backups | default([]) }}"
        report: []

    - name: Validate each volume backup
      include_tasks: ../tasks/validate_volume_backup.yml
      vars:
        vname: "{{ item.name }}"
        v_backups: "{{ backups | selectattr('volume_name','equalto', item.name) | list }}"
        latest_created: >-
          {{
            (v_backups | sort(attribute='created_at') | last).created_at
              if v_backups | length > 0 else ''
          }}
        latest_dt: "{{ latest_created | regex_replace('Z$','') | to_datetime('%Y-%m-%dT%H:%M:%S.%f') if latest_created != '' else none }}"
        now_dt: "{{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%S.%6N') | to_datetime('%Y-%m-%dT%H:%M:%S.%f') }}"
        age_seconds: "{{ (now_dt - latest_dt).total_seconds() if latest_dt is not none else 999999999 }}"
        rpo_seconds: "{{ rpo_hours * 3600 }}"
      loop: "{{ volumes }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Ensure logs directory exists
      file:
        path: logs
        state: directory

    - name: Save validation report
      copy:
        dest: "logs/backup_validation_{{ timestamp }}.json"
        content: "{{ report | to_nice_json }}"

    - name: Show summary
      debug:
        var: report

